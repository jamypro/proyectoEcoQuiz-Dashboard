<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel · EcoQuiz</title>
  <meta name="description" content="Panel de administración de EcoQuiz - usuarios y resultados en tiempo real (Firestore)">
  <style>
    /* ----------------- Reset y tipografía ----------------- */
    :root{
      --bg1:#0f172a; /* fondo oscuro */
      --accent1:#16a34a; /* verde */
      --accent2:#06b6d4; /* cyan */
      --card: rgba(255,255,255,0.04);
      --glass: rgba(255,255,255,0.06);
      --muted: rgba(255,255,255,0.7);
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    body{background:linear-gradient(135deg,var(--bg1),#06202b);color:#fff;padding:24px}

    /* ---------- Layout ---------- */
    .wrap{max-width:1100px;margin:0 auto}
    .card{background:var(--card);backdrop-filter:blur(6px);border-radius:12px;padding:18px; width: 100%;}

    /* ---------- Login ---------- */
    .login-center{display:grid;place-items:center;height:80vh}
    .login-box{width:100%;max-width:420px;padding:28px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));box-shadow:0 10px 30px rgba(2,6,23,0.6)}
    .brand{display:flex;gap:12px;align-items:center;margin-bottom:14px}
    .brand .dot{width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:700}
    h1{font-size:20px;margin:0}
    p.lead{color:var(--muted);margin-top:8px}
    .field{margin-top:12px}
    input[type=text],input[type=password]{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff}
    .btn{display:inline-block;padding:10px 14px;border-radius:10px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#04201a;border:none;cursor:pointer;margin-top:12px}
    .err{background:#2b0a0a;color:#ffd7d7;padding:8px;border-radius:8px;margin-top:10px;display:none}

    /* ---------- Dashboard ---------- */
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .search{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff}
    .tabs{display:flex;gap:8px;margin-top:18px}
    .tab{padding:8px 12px;border-radius:10px;cursor:pointer;background:transparent;border:1px solid rgba(255,255,255,0.03)}
    .tab.active{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#04201a}

    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:left}
    th{color:var(--muted);font-weight:600}
    tr:hover td{background:var(--glass)}
    .small{font-size:13px;color:var(--muted)}

    .actions{display:flex;gap:8px}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:8px;color:var(--muted);cursor:pointer}

    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.6))}
    .modal .panel{width:95%;max-width:820px;background:rgba(2,6,23,0.9);padding:18px;border-radius:12px}
    .modal .panel h3{margin:0}

    /* responsive */
    @media(min-width:900px){}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- LOGIN -->
    <div id="viewLogin" class="login-center">
      <div class="login-box card">
        <div class="brand"><div class="dot">EQ</div><div><h1>EcoQuiz · Panel</h1><p class="lead">Acceso exclusivo para la profesora</p></div></div>

        <div>
          <label class="small">Usuario</label>
          <div class="field"><input id="inpUser" type="text" placeholder="usuario" /></div>
        </div>
        <div>
          <label class="small">Contraseña</label>
          <div class="field"><input id="inpPass" type="password" placeholder="contraseña" /></div>
        </div>
        <div class="err" id="errLogin">Usuario o contraseña incorrectos</div>
        <div style="margin-top:12px"><button id="btnLogin" class="btn">Entrar</button></div>
        <p class="small" style="margin-top:10px;color:var(--muted)">Credenciales simuladas: <strong>profe2025 / claveSegura123</strong></p>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="viewDashboard" style="display:none">
      <div class="topbar">
        <div>
          <h2 style="margin:0">Panel · EcoQuiz</h2>
          <div class="small">Conexión en tiempo real</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <input id="q" class="search" placeholder="buscar por nombre..." />
          <button id="btnLogout" class="btn-ghost">Cerrar sesión</button>
        </div>
      </div>

      <div class="tabs" role="tablist">
        <div class="tab active" data-tab="usuarios">Usuarios registrados</div>
        <div class="tab" data-tab="resultados">Resultados</div>
      </div>

      <div id="panelUsuarios" class="card" style="margin-top: 18px;">
        <h3>Usuarios registrados (colección: <code>registros</code>)</h3>
        <p class="small">Actualizacion en tiempo real.</p>
        <div style="overflow:auto;margin-top:12px">
          <table>
            <thead>
              <tr><th>Nombre</th><th>Fecha/Hora</th></tr>
            </thead>
            <tbody id="tblUsuarios"></tbody>
          </table>
        </div>
      </div>

      <div id="panelResultados" class="card" style="display:none; margin-top: 18px;">
        <h3>Resultados (colección: <code>resultados</code>)</h3>
        <p class="small">Actualizacion en tiempo real.</p>
        <div style="overflow:auto;margin-top:12px">
          <table>
            <thead>
              <tr>
                <th>Jugador</th>
                <th>Puntaje</th>
                <th>Tiempo</th>
                <th>Aciertos</th>
                <th>Fallos</th>
                <th>Fecha</th>
                <th>Detalle</th>
              </tr>
            </thead>
            <tbody id="tblResultados"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal detalle -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="panel card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Detalle de la partida</h3>
        <div><button id="closeModal" class="btn-ghost">Cerrar</button></div>
      </div>
      <div id="modalBody" style="margin-top:12px;max-height:60vh;overflow:auto"></div>
    </div>
  </div>

  <!-- Script: Firebase + lógica -->
  <script type="module">
    // ---------- FIREBASE CONFIG ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      onSnapshot,
      query,
      orderBy,
      where,
      doc,
      getDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB-rhX6nz7CjgRT5o6LApehZHgX5TORKvA",
      authDomain: "ecoquiz-e32ac.firebaseapp.com",
      projectId: "ecoquiz-e32ac",
      storageBucket: "ecoquiz-e32ac.appspot.com",
      messagingSenderId: "1101966762734",
      appId: "1:1101966762734:web:9e3334d2ce54770e6d0d6f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---------- UI ----------
    const viewLogin = document.getElementById('viewLogin');
    const viewDashboard = document.getElementById('viewDashboard');
    const btnLogin = document.getElementById('btnLogin');
    const errLogin = document.getElementById('errLogin');
    const btnLogout = document.getElementById('btnLogout');
    const q = document.getElementById('q');

    const tblUsuarios = document.getElementById('tblUsuarios');
    const tblResultados = document.getElementById('tblResultados');

    const tabs = document.querySelectorAll('.tab');
    const panelUsuarios = document.getElementById('panelUsuarios');
    const panelResultados = document.getElementById('panelResultados');

    const modal = document.getElementById('modal');
    const modalBody = document.getElementById('modalBody');
    const closeModal = document.getElementById('closeModal');

    // credenciales simuladas
    const USER = 'sostenibilidad2025';
    const PASS = '123456789';

    btnLogin.addEventListener('click', ()=>{
      const u = document.getElementById('inpUser').value.trim();
      const p = document.getElementById('inpPass').value.trim();
      if(u === USER && p === PASS){
        viewLogin.style.display = 'none';
        viewDashboard.style.display = 'block';
        errLogin.style.display = 'none';
        startRealtime();
      } else { errLogin.style.display = 'block'; setTimeout(()=>errLogin.style.display='none',2500) }
    });

    btnLogout.addEventListener('click', ()=>{
      viewDashboard.style.display = 'none';
      viewLogin.style.display = 'block';
      // limpiar tablas
      tblUsuarios.innerHTML = '';
      tblResultados.innerHTML = '';
    });

    // tabs
    tabs.forEach(t => t.addEventListener('click', ()=>{
      tabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const tab = t.dataset.tab;
      if(tab === 'usuarios'){ panelUsuarios.style.display='block'; panelResultados.style.display='none'; }
      else { panelUsuarios.style.display='none'; panelResultados.style.display='block'; }
    }));

    // modal
    closeModal.addEventListener('click', ()=>{ modal.style.display='none'; modal.setAttribute('aria-hidden','true') });

    // ---------- Realtime listeners ----------

    function startRealtime(){
      const colUsers = collection(db,'registros');
      const qUsers = query(colUsers, orderBy('fechaRegistro','desc'));

      onSnapshot(qUsers, (snap)=>{
        tblUsuarios.innerHTML = '';
        snap.forEach(docSnap => {
          const d = docSnap.data();
          // convertir timestamp si existe
          console.log(d);
          let fecha = '-';
          if(d.fechaRegistro && d.fechaRegistro.seconds){
            const dt = new Date(d.fechaRegistro.seconds * 1000 + Math.floor(d.fechaRegistro.nanoseconds/1000000));
            fecha = dt.toLocaleString();
          }
          tblUsuarios.innerHTML += `<tr><td>${escapeHtml(d.Nombre||'-')}</td><td class='small'>${fecha}</td></tr>`;
        });
      }, err=>{
        console.error('Error usuarios realtime',err);
      });

      // resultados
      const colRes = collection(db,'resultados');
      const qRes = query(colRes, orderBy('fechaFinalizacion','desc'));
      onSnapshot(qRes, (snap)=>{
        tblResultados.innerHTML = '';
        snap.forEach(docSnap => {
          const d = docSnap.data();
          // timestamp conversion
          let fecha = '-';
          if(d.fechaFinalizacion && d.fechaFinalizacion.seconds){
            const dt = new Date(d.fechaFinalizacion.seconds * 1000 + Math.floor((d.fechaFinalizacion.nanoseconds||0)/1000000));
            fecha = dt.toLocaleString();
          }

          const tiempo = (d.tiempoTotal !== undefined) ? `${escapeHtml(String(d.tiempoTotal))}s` : '-';
          const puntaje = d.puntaje ?? '-';
          const aciertos = d.aciertos ?? (Array.isArray(d.preguntas) ? d.preguntas.filter(p=>p.correcta).length : '-');
          const fallos = d.fallos ?? (Array.isArray(d.preguntas) ? d.preguntas.filter(p=>!p.correcta).length : '-');

          const detallesEsc = escapeHtml(JSON.stringify(d.preguntas || []));

          tblResultados.innerHTML += `
            <tr>
              <td>${escapeHtml(d.nombre||'-')}</td>
              <td>${escapeHtml(String(puntaje))}</td>
              <td class='small'>${escapeHtml(tiempo)}</td>
              <td>${escapeHtml(String(aciertos))}</td>
              <td>${escapeHtml(String(fallos))}</td>
              <td class='small'>${escapeHtml(fecha)}</td>
              <td><div class='actions'><button class='btn-ghost' data-det='${detallesEsc}' onclick='verDetalle(this)'>Ver</button></div></td>
            </tr>
          `;
        });
      }, err=>{ console.error('Error resultados realtime', err) });
    }

    // abrir modal y mostrar preguntas (botón Ver llama a esta función)
    window.verDetalle = function(btn){
      try{
        const raw = btn.getAttribute('data-det') || '[]';
        const arr = JSON.parse(raw);
        renderDetalle(arr);
        modal.style.display = 'flex';
        modal.setAttribute('aria-hidden','false');
      }catch(e){ console.error(e) }
    }

    function renderDetalle(arr){
      if(!Array.isArray(arr)) arr = [];
      if(arr.length === 0){ modalBody.innerHTML = '<p class="small">No hay preguntas guardadas en este resultado.</p>'; return; }
      let html = '<ol>';
      arr.forEach((p, idx)=>{
        const correcta = p.correcta ? '<strong style="color:var(--accent1)">Correcta</strong>' : '<strong style="color:var(--danger)">Incorrecta</strong>';
        html += `
          <li style="margin-bottom:10px">
            <div style="font-weight:600">${escapeHtml(p.pregunta||'')}</div>
            <div class="small">Opciones: ${escapeHtml(Array.isArray(p.opciones)?p.opciones.join(', '):'')}</div>
            <div class="small">Respuesta correcta: ${escapeHtml(p.respuestaCorrecta||'-')}</div>
            <div class="small">Respuesta jugador: ${escapeHtml(p.respuestaJugador||'-')}</div>
            <div class="small">Estado: ${correcta}</div>
          </li>
        `;
      });
      html += '</ol>';
      modalBody.innerHTML = html;
    }

    // escape simple para evitar XSS por contenido
    function escapeHtml(str){
      if(str === null || str === undefined) return '';
      return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#039;');
    }

    // busqueda simple por nombre en la UI (filtrado local)
    q.addEventListener('input', ()=>{
      const term = q.value.trim().toLowerCase();
      // filtrar usuarios
      Array.from(tblUsuarios.querySelectorAll('tr')).forEach(tr=>{
        const name = tr.children[0].textContent.toLowerCase();
        tr.style.display = name.includes(term)?'':'none';
      });
      // filtrar resultados
      Array.from(tblResultados.querySelectorAll('tr')).forEach(tr=>{
        const name = tr.children[0].textContent.toLowerCase();
        tr.style.display = name.includes(term)?'':'none';
      });
    });

  </script>
</body>
</html>
